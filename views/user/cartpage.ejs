<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ToteTreasures Hub - Cart Page</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href='https://fonts.googleapis.com/css?family=Italianno' rel='stylesheet'>
  <link rel="stylesheet" type="text/css" href="/css/cartpage.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/MaterialDesign-Webfont/5.3.45/css/materialdesignicons.css" />
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
</head>

<body>

  <nav class="navbar navbar-expand-lg navbar-dark" style="background-color: black;">
    <div class="container-fluid d-flex justify-content-between align-items-center">
      <a class="navbar-brand" href="">
        <img src="/images/logo.png" style="max-height: 70px" alt="logo">
        <h3 class="text-white fw-bold m-0 d-inline align-middle">ToteTreasures Hub</h3>
      </a>

     
      <form class="d-flex" role="search" action="/search" method="GET">
        <input class="form-control me-2" type="search" name="searchNames" placeholder="Search" aria-label="Search">
        <button class="btn btn-outline-success" type="submit">Search</button>
      </form>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="/homepage">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="/shop">Shop</a></li>
          <li class="nav-item"><a class="nav-link" href="/wishlist">WishList <i
                class="fa-solid fa-heart text-danger"></i></a></li>
          <li class="nav-item">
            <a class="nav-link" href="/cartpage">Cart <i class="fa-solid fa-cart-shopping text-primary"></i>
              <% if (cartCount> 0) { %>
                <span id="cart-quantity" class="badge bg-danger">
                  <%= cartCount %>
                </span>
                <% } %>
            </a>
          </li>
          <li class="nav-item ml-auto">
            <% if (user) { %>
            <div class="dropdown">
              <a href="#" class="dropdown-toggle nav-link" id="usernameLink" data-bs-toggle="dropdown">
                <%= user.username %> <i class="fa-solid fa-user"></i>
              </a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="/profile">Profile</a></li>
                <li>
                  <hr class="dropdown-divider" />
                </li>
                <li><a class="dropdown-item" href="/logout" id="logoutLink">Logout</a></li>
              </ul>
            </div>

              <% } else { %>
                <div class="d-flex align-items-center">
                  <a class="nav-link" href="/signup"><i class="fa-solid fa-user-plus"></i> Sign Up</a>
                  <span class="nav-link">|</span>
                  <a class="nav-link" href="/login"><i class="fa-solid fa-sign-in-alt"></i> Login</a>
                </div>
                <% } %>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <% let totalPrice=0; %>

    <section class="bg-light" style="min-height:76vh;">
      <form id="cartSubmit">
        <div class="container">
          <div class="row">

           
            <div class="col-lg-9">
              <div class="card border shadow-0 m-4">
                <div class="m-4">
                  <h4 class="card-title mb-4">Your shopping cart</h4>

                  <% if (cart && cart.Items && cart.Items.length> 0) { %>
                    <% cart.Items.forEach(function (cartItem) { %>
                      <div class="row gy-3 mb-4">
                        <div class="col-lg-5">
                          <div class="d-flex">
                            <img src="/uploads/<%= cartItem.ProductId.images[0] %>" class="border rounded me-3"
                              style="width: 96px; height: 96px" />
                            <div>
                              <a href="#" class="nav-link text-dark">
                                <%= cartItem.ProductId.ProductName %>
                              </a>
                            </div>
                          </div>
                        </div>

                   
                        <div class="col-lg-2 col-sm-6 col-6">
                          <div class="cart-quantity-price">

                     
                            <div class="input-group">
                              <button class="btn btn-dark decrease-quantity"
                                data-product-id="<%= cartItem.ProductId._id %>" type="button">-</button>

                              <input type="number" class="form-control quantity-input"
                                id="count_<%= cartItem.ProductId._id %>" value="<%= cartItem.Quantity %>" min="1"
                                max="<%= cartItem.ProductId.AvailableQuantity %>"
                                data-available-quantity="<%= cartItem.ProductId.AvailableQuantity %>" readonly />

                              <button class="btn btn-dark increase-quantity"
                                data-product-id="<%= cartItem.ProductId._id %>" type="button">+</button>
                            </div>

                 
                            <div>
                              <% if (cartItem.ProductId.offer) { %>
                                ₹ <span class="h6 product-amount" id="productAmount_<%= cartItem.ProductId._id %>"
                                  data-value="<%= cartItem.ProductId.offerPrice %>">
                                  <%= cartItem.ProductId.offerPrice * cartItem.Quantity %>
                                </span>/-<br />
                                <small class="text-muted">₹<%= cartItem.ProductId.offerPrice %> / per item</small>
                                <% } else { %>
                                  ₹ <span class="h6 product-amount" id="productAmount_<%= cartItem.ProductId._id %>"
                                    data-value="<%= cartItem.ProductId.DiscountAmount %>">
                                    <%= cartItem.ProductId.DiscountAmount * cartItem.Quantity %>
                                  </span>/-<br />
                                  <small class="text-muted">₹<%= cartItem.ProductId.DiscountAmount %> / per item</small>
                                  <% } %>
                            </div>

                          </div>
                        </div>

           
                        <div class="col-lg col-sm-6 d-flex justify-content-end align-items-center">
                          <div>
                            <strong class="card-text text-danger out-of-stock-message"
                              id="outOfStockMessage_<%= cartItem.ProductId._id %>" style="display: none;">
                              only <%= cartItem.ProductId.AvailableQuantity %> items in stock
                            </strong>
                            <a href="/removefromcart/<%=cartItem.ProductId._id%>"
                              class="btn btn-light border text-danger icon-hover-danger remove-button">
                              Remove
                            </a>
                          </div>
                        </div>
                      </div>

                      <% if (cartItem.ProductId.offer) { %>
                        <% totalPrice +=cartItem.ProductId.offerPrice * cartItem.Quantity; %>
                          <% } else { %>
                            <% totalPrice +=cartItem.ProductId.DiscountAmount * cartItem.Quantity; %>
                              <% } %>
                                <% }); %>
                                  <% } else { %>
                                    <p>Your shopping cart is empty.</p>
                                    <a href="/shop" class="btn btn-info">Go To Shop</a>
                                    <% } %>
                </div>
              </div>
            </div>

    
            <div class="col-lg-3 mt-4">
              <div class="card border shadow-0 mb-2 ">
                <div class="card-body">
                  <% if (coupons.length> 0) { %>
                    <div class="form-group">
                      <label class="form-label">Select Coupon</label>
                      <select id="couponDropdown" class="form-control">
                        <% if (cart?.coupon) { %>
                          <option value="<%= cart.coupon.code %>" disabled selected>
                            <%= cart.coupon.code %> (₹<%= cart.coupon.discount_amount %> off, Min: ₹<%=
                                  cart.coupon.minimum_purchase %>)
                          </option>
                          <% } else { %>
                            <option value="" disabled selected>Check Coupon</option>
                            <% } %>
                              <% coupons.forEach(coupon=> { %>
                                <option value="<%= coupon.code %>">
                                  <%= coupon.code %> (₹<%= coupon.discount_amount %> off, Min: ₹<%=
                                        coupon.minimum_purchase %>)
                                </option>
                                <% }); %>
                      </select>
                      <br>
                      <button type="button" class="btn btn-light border applyCoupon">Apply Coupon</button>
                    </div>
                    <% } else { %>
                      <p>No coupons available.</p>
                      <% } %>
                </div>
              </div>

              <div class="card shadow-0 border mb-2">
                <div class="card-body">
                  <div class="d-flex justify-content-between">
                    <p class="mb-2">Sub Total :</p>
                    <div id="sub-total">
                      <%= totalPrice %>
                    </div>
                  </div>

                  <div class="d-flex justify-content-between">
                    <p class="mb-2">Discount:</p>
                    <div id="discountCell">
                      <% if (cart?.Items && cart.Items.length> 0 && cart?.coupon && cart?.coupon.discount_amount) { %>
                        - ₹<%= cart.coupon.discount_amount %>
                          <% } else { %>
                            0.00
                            <% } %>
                    </div>
                  </div>

                  <hr />

                  <div class="d-flex justify-content-between">
                    <p class="mb-2">Total price:</p>
                    <input type="text" id="totalAmountCell" class="transparent-input" name="totalPrice"
                      value="<%= totalPrice %>" readonly>
                    <% if(cart?.coupon){ %>
                      <input type="hidden" id="minAmount" value="<%= cart.coupon.minimum_purchase %>">
                      <% } else { %>
                        <input type="hidden" id="minAmount" value="">
                        <% } %>
                  </div>

                  <div class="mt-3">
                    <button id="makePurchase" type="button" class="btn btn-success w-100 shadow-0 mb-2">
                      Make Purchase
                    </button>
                    <a href="/homepage" class="btn btn-light w-100 border mt-2">Back to shop</a>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>
      </form>
    </section>

<!-- ✅ Safe injection: avoids VS Code syntax errors -->
<script>
  window.serverAppliedCoupon = JSON.parse('<%- JSON.stringify(cart && cart.coupon ? cart.coupon : null) %>');
  window.serverCartTotals = JSON.parse('<%- JSON.stringify({subTotal: typeof totalPrice !== "undefined" ? Number(totalPrice) : 0,discount: cart && cart.coupon && cart.coupon.discount_amount ? Number(cart.coupon.discount_amount) : 0}) %>');
</script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="/js/cartpage.js"></script>
    <%- include('../layouts/footer') %>
</body>

</html>

