<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Order Management | ToteTreasures Hub</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href='https://fonts.googleapis.com/css?family=Italianno|Poppins:400,500,600' rel='stylesheet'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">

    <!-- Custom Styles -->
    <link rel="stylesheet" type="text/css" href="/css/admin/orderpage.css">
</head>


<body>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg main-nav">
        <div class="container-fluid d-flex align-items-center">
            <button class="btn btn-outline-warning me-2" type="button" data-bs-toggle="offcanvas"
                data-bs-target="#offcanvasMenu" aria-controls="offcanvasMenu">
                <i class="fa-solid fa-bars"></i>
            </button>
            <a class="navbar-brand d-flex justify-content-start" href="#">
                <img src="/images/logo.png" alt="Logo">
            </a>
            <h1 class="header m-0 fs-4 text-white">ToteTreasures Hub</h1>

            <div class="collapse navbar-collapse d-flex justify-content-end">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="btn btn-danger btn-sm" href="/admin/logout"><i class="fa fa-sign-out-alt me-1"></i> Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Sidebar -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasMenu" aria-labelledby="offcanvasMenuLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="offcanvasMenuLabel">Admin Options</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body p-0">
            <ul class="list-group custom-list">
                <a href="/admin/dashboard" class="list-group-item custom-list-item"><i class="fas fa-house me-2"></i>Dashboard</a>
                <a href="/admin/product" class="list-group-item custom-list-item"><i class="fas fa-bag-shopping me-2"></i>Products</a>
                <a href="/admin/order" class="list-group-item custom-list-item"><i class="fas fa-cart-shopping me-2"></i>Orders</a>
                <a href="/admin/userslist" class="list-group-item custom-list-item"><i class="fas fa-users me-2"></i>Customers</a>
                <a href="/admin/coupons" class="list-group-item custom-list-item"><i class="fas fa-id-card me-2"></i>Coupons</a>
                <a href="/admin/brandpage" class="list-group-item custom-list-item"><i class="fas fa-user-plus me-2"></i>Brands</a>
                <a href="/admin/Categorypage" class="list-group-item custom-list-item"><i class="fas fa-list me-2"></i>Categories</a>
                <a href="/admin/offers" class="list-group-item custom-list-item"><i class="fas fa-money-bill me-2"></i>Offers</a>
            </ul>
        </div>
    </div>

    <!-- Orders Section -->
    <div class="container-fluid mt-4 mb-5 px-3">
        <% if (orders.length > 0) { %>
            <div class="table-responsive shadow-lg rounded">
                <table class="table table-bordered table-hover align-middle">
                    <thead class="table-dark">
                        <tr>
                            <th>Order ID</th>
                            <th>User Email</th>
                            <th>Order Date</th>
                            <th>Total Amount</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>

                    <tbody>
                        <% orders.forEach((order, index)=> { %>
                            <tr>
                                <td><%= order._id %></td>
                                <td class="text-break"><%= order.UserId.Email %></td>
                                <td><%= new Date(order.OrderDate).toLocaleDateString() %></td>
                                <td>â‚¹<%= order.TotalPrice %></td>
                              <td>
    <% if (order.Status === "Return Pending") { %>
        <button type="button" class="btn btn-warning btn-sm text-dark fw-semibold" data-bs-toggle="modal"
            data-bs-target="#returnModal<%= order._id %>">Return Requested</button>

    <% } else if (order.Status === 'Cancelled') { %>
        <span class="text-danger fw-semibold">Cancelled</span>

    <% } else if (order.Status === 'Return Canceled') { %>
        <span class="text-muted fw-semibold">Return Canceled</span>

    <% } else if (order.Status === 'Return Accepted') { %>
        <span class="text-success fw-semibold">Returned</span>

    <% } else if (order.Status === 'Rejected') { %>
        <span class="text-danger fw-semibold">Rejected</span>

    <% } else if (order.Status === 'Delivered') { %>
        <span class="text-success fw-semibold">Delivered</span>

    <% } else { %>
        <% const currentStatus = order.Status || 'Order Placed'; %>
        <select class="form-select form-select-sm text-white bg-dark border-secondary"
            id="statusSelect<%= index %>"
            onchange="changeOrderStatus('<%= order._id %>', '<%= index %>')">
            <option value="Order Placed" <%= currentStatus==='Order Placed' ? 'selected' : '' %>>Order Placed</option>
            <option value="Shipped" <%= currentStatus==='Shipped' ? 'selected' : '' %>>Shipped</option>
            <option value="Delivered" <%= currentStatus==='Delivered' ? 'selected' : '' %>>Delivered</option>
            <option value="Rejected" <%= currentStatus==='Rejected' ? 'selected' : '' %>>Rejected</option>
        </select>
    <% } %>
</td>

                                <td>
                                    <a href="/admin/order/details/<%= order._id %>">
                                        <button class="btn btn-primary btn-sm"><i class="fa fa-eye me-1"></i>View</button>
                                    </a>
                                </td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
         <!-- Floating Pagination -->
<% if (orders.length > 0) { %>
    <nav aria-label="Page navigation" class="floating-pagination">
        <ul class="pagination custom-pagination mb-0">
            <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
                <a class="page-link" href="?page=<%= currentPage - 1 %>">
                    <i class="fa fa-angle-left"></i>
                </a>
            </li>

            <% for (let i = 1; i <= totalPages; i++) { %>
                <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                    <a class="page-link" href="?page=<%= i %>"><%= i %></a>
                </li>
            <% } %>

            <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
                <a class="page-link" href="?page=<%= currentPage + 1 %>">
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
<% } %>


        <% } else { %>
            <div class="card text-center mt-4">
                <div class="card-body">
                    <h5 class="card-title text-warning">No Orders Yet</h5>
                    <p class="card-text">There are currently no orders available.</p>
                </div>
            </div>
        <% } %>
    </div>

    <!-- Return Modals -->
    <% orders.forEach(function (order) { %>
        <div class="modal fade" id="returnModal<%= order._id %>" tabindex="-1" aria-labelledby="returnModalLabel<%= order._id %>" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="returnModalLabel<%= order._id %>">Return Request</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure you want to accept the return request?</p>
                        <p class="text-warning">Reason: <span class="text-light"><%= order.ReturnReason || 'Not provided' %></span></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-danger btn-sm" onclick="cancelReturn('<%= order._id %>')">Cancel</button>
                        <button type="button" class="btn btn-success btn-sm" onclick="acceptReturn('<%= order._id %>')">Accept</button>
                    </div>
                </div>
            </div>
        </div>
    <% }); %>

    <script src="/js/adminorderlist.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
